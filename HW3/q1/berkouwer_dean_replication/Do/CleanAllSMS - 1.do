/*This script does not run. It relies on PII that is not in the raw datasets. 
The output that should be created in this script is generated in the not publicly
available version of this script */

include "${main}/Do/0. Master.do"
clear all 

********* Create a treatments file for use in CleanSMSdata *********

preserve
	use "`datamed'/Visit12_clean_replication.dta", clear
	keep v1_phone_number respondent_id baseline_date treata treatc treata_pooled treatc_pooled 
	rename v1_phone_number phone_number
	isid respondent_id
	isid phone_number
	save "`datamed'/RespondentTreatments_replication_2.dta", replace
	cap saveold "`datamed'/RespondentTreatments_replication_2.dta", replace version(12)
restore


********* Create a treatments file for use in CleanSMSdata *********
foreach file in "2019-04-17_2019-07-31" {
	preserve
		import excel using "`raw'/SMS Responses/Messages_`file'.xlsx", clear firstrow
		
		tempfile import
		save `import'
	restore
	
	append using `import'
}


duplicates drop
save "`datamed'/SMS_incoming_replication.dta", replace

*************** USE DATA ****************** 
include "${main}/Do/0. Master.do"
use "`datamed'/SMS_incoming_replication.dta", clear

* Fix respondent:
g phone_number = substr(RESPONDENT, strpos(RESPONDENT, "+")+4, .)
g SMS_name = substr(RESPONDENT, 1, strpos(RESPONDENT, "+")-2)
drop RESPONDENT

* People who have started responding with a different number: 
replace phone_number="*******26" if phone_number=="*******74"
replace phone_number="*******90" if phone_number=="*******82"
replace phone_number="*******68" if phone_number =="*******65"
replace phone_number="*******76" if phone_number =="*******95"

replace phone_number="*******44" if phone_number =="*******56"
replace phone_number="*******51" if phone_number =="*******47"
replace phone_number="*******88" if phone_number =="*******60"
replace phone_number="*******54" if phone_number =="*******98"
replace phone_number="*******95" if phone_number =="*******65"

replace phone_number="*******08" if phone_number =="*******49"
replace phone_number="*******73" if phone_number =="*******63"
replace phone_number="*******62" if phone_number =="*******62"

replace phone_number="*******55" if phone_number =="*******85"
replace phone_number="*******96" if phone_number =="*******00"
replace phone_number="*******59" if phone_number =="*******27"
replace phone_number="*******24" if phone_number =="*******15"
replace phone_number="*******66" if phone_number =="*******19"
replace phone_number="*******08" if phone_number =="*******79"

* 1 person has withdrawn consent: 
drop if phone_number=="*******08"

* Extract date:
g SMS_date=date(subinstr(substr(DATETIMERECIEVED, 1, strpos(DATETIMERECIEVED, "2019")+4), ",", "", .), "MDY",2019)
format SMS_date %td
g SMS_hour= trim(substr(DATETIMERECIEVED, strpos(DATETIMERECIEVED, "2019")+6, 2))
replace SMS_hour = subinstr(SMS_hour, ":", "", .)
g SMS_min= trim(substr(DATETIMERECIEVED, strpos(DATETIMERECIEVED, ":")+1, 2))
replace SMS_min = "0" if !strpos(DATETIMERECIEVED, ":")
destring SMS_hour SMS_min, replace
replace SMS_hour = SMS_hour + 12 if strpos(DATETIMERECIEVED, "p.m.")
drop DATETIMERECIEVED

rename MESSAGE message 
duplicates drop

* Import respondent_id and treatment status from surveys
merge m:1 phone_number using "`datamed'/RespondentTreatments_replication_2.dta"
tab phone_number if _merge ==1
assert _merge!=1 // All SMSes can be matched to a respondent
drop if _merge == 2 // Drop non-SMS respondents
assert _merge == 3
drop _merge

********* Clean some respondent_id *********
replace respondent_id="380e07" if respondent_id=="3.80E+07"
replace respondent_id = lower(respondent_id)


* REPLACE SURVEY ID SO THEY DO NOT HAVE E IN THEM (excel has a hard time reading):
replace respondent_id = subinstr(respondent_id, "e", "z", .)
replace respondent_id = subinstr(respondent_id, "+", "", .)
replace respondent_id = subinstr(respondent_id, ".", "", .)

include "${main}/Do/0. Master.do"
* Import V2 date: 
preserve
	use "`datamed'/Visit12_clean_replication.dta", clear
	keep midline respondent_id
	isid respondent_id 
	sort respondent_id
	tempfile V2
	save `V2'
restore

merge m:1 respondent_id using `V2'
assert _m != 1 // Always some survey


* Can be =1 for people without a V2, or =2 for people who never SMSed
drop _merge


*************** BASICS ****************** 

replace phone_number = lower(phone_number)
/* These are not actual phone numbers, and that's why we drop these observations. */
drop if phone_number == "safaricom" | phone_number == "saf offers" | ///
	phone_number == "^22876" | phone_number == "22876" 
drop if strpos(message, "You attempted to call me but I was not available")
drop if strpos(message, "Bundle")
drop if strpos(message, "INSTANTLY!")


g amount = trim(message)

/*TODO: black out this */


foreach PII in "Nm***************************************************" "Gu************************************************************************" "I*****************************************************************************************************************************" "22******************************************" "Kw****************************************" "kw******************************************************************************************************" "so***********************************************************************************" "Sa**************************************************************************************************************************************************************************************************************************************************************************************************" "Kw********************************************************************" "Kw*****************************************************************" "Kw******************************************" "Li**********" "PL**************************************************************************" "Kw************************************************************************************************" "Kw**************************************************************" "Uw*******************************************************************************************************" "Hi******************************************" "Kw*************************************" "Ku*******************************************************************************" "um****************************" "He****************************************************************************************************************************" "Na******************************************************" "Li**************" "NF**********************************************************************************************************************************************************************************" "Si************************************************************************************************" "Hu*************************************************************************************************************************************************************************************************************" "Yo**********************************************************************************************************************************************************" "07******************************" "30*************" "Mi******************" "Si***********************************************************" "su**********************************************" "ni**************************" "ni*********************" "ni*************************" "NF*******************************************************************************************************************************************************" "NF*****************************************************************************************************************************************************" "NF******************************************************************************************************************************************************" "Ni*************" "Mi*******************************************" "KW************************************" "KW********************************************" "KW**********************************************************" "KW*******************************************" "KW***********************************************" "KW***************************************************************************************************************************" "As********************************************************************************************************************" "Ji******************************************" "Di***************************************************" "Ni**************************************************************************" "NG********************************************************************************************************************************************************" "Mi******************" "Re******************************************************" "Ta*********************************************************************************************" "Mi****************" "Si**************************************************" "ta********************************************************************************" "Mi************************************************************************************************" "Yo************************************************************" "07*****************" "07*************************************************" "Nl*****************************" "Si****************" "si**********************************" "NF*****************************************************************************************************************************************************" "NE**************************************************************************************************************************************************************" "Kw********************************************" "na********************************" "NF************************************************************************************************************************************************************" "Ni*******************************************" "Ni************************************************" "Al****************************************" "NF******************************************************************************************************************************************************" "Kw*************************************************************************" ".n******************************************************************************************************************************************************************************************" "na*************************************" "Re***************************************************************************************************************************************************************************************************" "NG*********************************************************************************************************************************************************" "30*******************************************" "He*********************************************************************************" "Nm********************************************************************************************************************************************" "SI**********************************************************************************" "NF********************************************************************************************************************************************************" "Qw**************************************************************************************************" "Ni****************************************" "Sp***************************************************************************************************************************************" "Sa****************************************************************************************************************************************************" "Kw**************************************************************" "NG************************************************************************************************************************************************************" "NF******************************************************************************************************************************************************" "Ma*************************************************************************************************************************************************************************" "NG*******************************************************************************************************************************************************************************************" "KW***********************************************************" "Ni*************************************************************************" "Hi******************************************************************************************************************************************************" "Kw***************************************************************************" "Pl************************************************************************************************************************************************************************************************************************************************************************************" "Fa**********************************************************************************************************************" "NI**************************************************************************************************************************************************************************************************************" "Po************************" "Ml******************************************************************************************************" "Nz****************" "+0*************" "Re**********************************************************************************************************************************************************************************************" "Et*******************************************************************************************************************" "Mi****************************" "IA****************************************" "Ta**************************************************************************************" "SI********************************************************************************" "Ni************************************" "Sa*******************************************************************" "07********" "Hi*******************" "Ni***********************************" "07***************************************************************************" "Na******************************************************************************************************************************************************************" "ni**************************************************************************" "Ul**********************************************" {
	drop if message == "`PII'" | amount == "`PII'" 
	di "`PII'"
}


drop if strpos(message, "*****")>0

drop if strpos(message, "+*************") > 0

drop if respondent_id == "b747379" & SMS_hour == 6 & SMS_min == 27

drop if respondent_id == "cb14ccb" & SMS_hour == 9 & SMS_min == 54

drop if respondent_id == "caf3z35" & SMS_hour == 18 & SMS_min == 27

drop if respondent_id == "7416z2b" & SMS_hour == 18 & SMS_min == 43

drop if respondent_id == "40c0232"  & SMS_hour == 9 & SMS_min == 8

replace message = "490" if message == "490 --****** *********"
replace message = "500" if message == "500 --****** *********"
replace message = "689" if message == "On 22nd  sato nililipa ksh.689. ******* a/ c *****"
replace message = "300" if message == "*******,*******300,sh"
destring message, gen(num_message) force

drop if num_message > 3500 & num_message != . /*Delete 3 obs. with numbers that do not make sense/letters */
tab num_message

drop num_message phone_number SMS_name

save "`datamed'/SMS_2019.dta", replace

